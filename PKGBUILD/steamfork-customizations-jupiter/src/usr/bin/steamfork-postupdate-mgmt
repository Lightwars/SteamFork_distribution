#!/bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2024-Present Fewtarius (https://github.com/fewtarius)

function check_network() {
  GW=$(ip route | awk '/eth0/ {a=$0} END{print $1}')
  if [[ ${GW} =~ [0-9] ]]
  then
    echo true
  else
    echo false
  fi
}

### We should wait for network to come online before proceeding so
### any post-update hooks that need it will succeed.

while true
do
  AM_I_ONLINE=$(check_network)
  if [ "${AM_I_ONLINE}" = "true" ]
  then
    break
  fi
  sleep 1
done

### Check for the last update stamp, and if it isn't a match
### run any post-update scripts and then update the stamp.

UPDATE_STAMP="/etc/post-update.last"
source /etc/os-release
if [ -e "${UPDATE_STAMP}" ]
then
  LAST_UPDATE="$(cat ${UPDATE_STAMP})"
fi

if [ ! "${LAST_UPDATE}" = "${BUILD_ID}" ]
then
  steamos-readonly disable >/var/log/update.log 2>&1
  if [ -d "/etc/post-update.d" ]
  then
    for UPDATE in /etc/post-update.d/*
    do
      ${UPDATE} >>/var/log/update.log 2>&1
    done
  fi
  steamos-readonly enable >>/var/log/update.log 2>&1
  echo "${BUILD_ID}" >${UPDATE_STAMP}
fi
exit 0
